<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>整合服装管理与展示</title>
  <style>
    /* CSS Reset (Simplified) - 基础样式重置 */
    body, h1, h2, h3, p, ul, li, figure {
      margin: 0;
      padding: 0;
      border: 0;
      font-size: 100%;
      font: inherit;
      vertical-align: baseline;
      box-sizing: border-box; /* 确保 padding 和 border 包含在元素的总宽度和高度内 */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      line-height: 1.6;
      background-color: #f4f4f4;
      color: #333;
      display: flex; /* 使用 Flexbox 实现全屏三列布局 */
      min-height: 100vh; /* 确保页面至少占满视口高度 */
      overflow-x: hidden; /* 防止水平滚动 */
    }

    ul {
      list-style: none; /* 移除列表默认点 */
    }

    a {
      text-decoration: none; /* 移除链接下划线 */
      color: inherit; /* 链接颜色继承父级 */
    }

    img {
      max-width: 100%; /* 图片不超过父容器 */
      display: block; /* 移除图片底部空白 */
    }

    /* 全局布局 */
    .integrated-container {
      display: flex;
      width: 100%;
      max-width: 100vw; /* 确保全屏宽度 */
    }

    /* 左侧画廊列 */
    .gallery-column {
      flex: 1; /* 占据一份空间 */
      min-width: 300px; /* 最小宽度 */
      background-color: #f4f4f4;
      padding: 5px;
      overflow-y: auto; /* 允许内容滚动 */
      display: flex;
      flex-direction: column;
    }

    /* 中间详情页列 */
    .detail-column {
      flex: 1; /* 占据一份空间 */
      min-width: 300px; /* 最小宽度 */
      background-color: #fff;
      padding: 5px;
      overflow-y: auto; /* 允许内容滚动 */
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: flex-start; /* 内容从左上角开始 */
      justify-content: flex-start; /* 内容从顶部开始 */
      position: relative; /* 用于定位详情内容 */
    }
    .detail-column .product-detail-content {
        width: 100%;
        max-width: 400px; /* 限制详情内容的最大宽度 */
        aspect-ratio: 9 / 16; /* 移动端比例 */
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        padding: 10px;
        display: none; /* 初始隐藏 */
        margin: 0 auto; /* 居中显示 */
    }
    .detail-column .product-detail-content.active {
        display: block; /* 选中时显示 */
    }
    .detail-column .placeholder-message {
        width: 100%; /* 确保占位符也居中 */
        text-align: center;
        color: #888;
        padding: 20px;
        font-size: 1.1rem;
        margin-top: 50px;
    }


    /* 右侧管理后台列 */
    .admin-column {
      flex: 1; /* 占据一份空间 */
      min-width: 300px; /* 最小宽度 */
      background-color: #f4f4f4;
      padding: 20px;
      overflow-y: auto; /* 允许内容滚动 */
    }
    .admin-column .admin-container {
        max-width: 600px; /* 保持 admin.html 的最大宽度 */
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }


    /* 画廊头部样式 */
    header {
      background-color: #fff;
      padding: 15px 0;
      text-align: center;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* 轻微阴影 */
      flex-shrink: 0; /* 防止 header 缩小 */
    }

    header .logo {
      font-size: 1.8rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }

    nav {
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    
    /* 筛选器组样式 */
    .filter-group {
      margin-bottom: 10px;
      padding: 0 10px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .filter-group strong {
        color: #555;
        font-size: 0.9em;
        margin-right: 8px;
        flex-shrink: 0;
    }

    nav .filter-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    /* 筛选标签样式 */
    nav a.filter-tag {
        display: inline-block;
        padding: 4px 8px;
        background-color: #e9ecef;
        color: #495057;
        border-radius: 5px;
        font-size: 0.85rem;
        transition: background-color 0.2s, color 0.2s;
        flex-shrink: 0;
        cursor: pointer;
    }

    nav a.filter-tag.active {
      background-color: #00aaff;
      color: #fff;
    }
    nav a.filter-tag:hover:not(.active) {
        background-color: #d8dee3;
    }

    /* 商品列表网格布局 */
    .products {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(45%, 1fr)); /* 移动端双排 */
      gap: 5px;
      flex-grow: 1; /* 占据剩余空间 */
    }

    /* 商品卡片样式 */
    .product-card {
      background-color: #fff;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease-in-out;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .product-card:hover {
      transform: translateY(-5px);
    }
    .product-card > a { /* 使整个卡片可点击 */
        cursor: pointer;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .product-card img {
      width: 100%;
      height: auto; 
      aspect-ratio: 3 / 4; /* 维持 3:4 的宽高比 */
      object-fit: cover;
      object-position: center;
    }

    .product-info {
        padding: 10px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .product-name-price {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 5px;
        flex-wrap: wrap;
    }

    .product-name-price h2 {
      font-size: 1.1rem;
      font-weight: bold;
      margin: 0;
      flex-grow: 1;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      order: 2; /* 名称在第二个 */
    }
    .product-name-price .price {
      font-size: 1.1rem;
      font-weight: bold;
      color: #e64a19;
      margin-right: 10px;
      flex-shrink: 0;
      order: 1; /* 价格在第一个 */
    }

    .product-tags, .product-season {
        font-size: 0.65rem;
        color: #777;
        margin-bottom: 3px;
        line-height: 1.2;
    }
    
    .product-tags span, .product-season span {
        display: inline-block;
        margin-right: 5px;
        padding: 2px 6px;
        border-radius: 3px;
    }

    .product-tags span {
        background-color: #f7f7df;
    }

    .product-season span {
        background-color: #e1f5ff;
    }

    .product-season {
        margin-top: auto;
        padding-top: 5px;
        border-top: 1px dashed #eee;
    }

    /* 商品详情页样式 (原模态框内容) */
    .product-detail-content .modal-nav {
        position: sticky;
        top: 0;
        left: 0;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        z-index: 1001;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        padding: 5px 0;
    }

    .product-detail-content .modal-nav .back-button {
        font-size: 1rem;
        font-weight: normal;
        color: #333;
        text-decoration: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: 5px;
        transition: background-color 0.2s;
        flex-shrink: 0;
    }
    .product-detail-content .modal-nav .back-button::before {
        content: '←';
        font-size: 1.4rem;
        line-height: 1;
    }

    .product-detail-content .modal-nav .product-title {
        flex-grow: 1;
        text-align: center;
        font-size: 1.1rem;
        font-weight: bold;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .product-detail-content .modal-nav .modal-nav-price {
        font-size: 1.1rem;
        font-weight: bold;
        color: #e64a19;
        margin-left: 10px;
        flex-shrink: 0;
        padding: 5px 10px;
        border-radius: 5px;
    }

    .product-detail-content .modal-content-inner { /* 区分原 modal-content */
      max-width: 100%;
      min-width: 300px;
      position: relative;
      margin: 0 auto;
      padding-top: 10px;
      flex-grow: 1;
      overflow-y: auto;
    }

    .product-detail-content .modal-content-inner img {
      width: 100%;
      height: auto;
    }
    .product-detail-content .modal-description {
        font-size: 0.95rem;
        color: #555;
        margin-top: 15px;
        padding: 10px;
        border-top: 1px dashed #eee;
    }


    footer {
      text-align: center;
      margin-top: 10px;
      padding: 5px 0;
      background-color: #ddd;
      font-size: smaller;
      font-weight: light;
      flex-shrink: 0; /* 防止 footer 缩小 */
    }

    /* 加载状态 */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        font-size: 1.2rem;
        color: #007bff;
        text-align: center;
    }
    #loading-overlay span.spinner {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        border: 0.25rem solid rgba(0,0,0,.15);
        border-right-color: #007bff;
        border-radius: 50%;
        animation: spinner-border .75s linear infinite;
        margin-bottom: 10px;
    }
    @keyframes spinner-border {
        to { transform: rotate(360deg); }
    }
    
    #loading-overlay.hidden {
        display: none;
    }

    /* admin.html 样式 */
    .admin-column h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    /* 通用输入框和标签样式 */
    .admin-column label {
      font-weight: bold;
      flex-shrink: 0;
      margin-bottom: 0px;
      white-space: nowrap;
      text-align: left !important;
    }
    .admin-column input[type="text"],
    .admin-column input[type="number"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      flex-grow: 1;
      margin-bottom: 0;
    }
    /* 禁用状态的输入框样式 */
    .admin-column input:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }
    .admin-column button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    /* API Token 部分 */
    .admin-column .api-token-section {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    .admin-column .api-token-section label {
        margin-right: 10px;
    }
    .admin-column .api-token-section input {
        margin-right: 10px;
    }
    .admin-column .api-token-section button {
        padding: 8px 15px;
        font-size: 0.9em;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        flex-shrink: 0;
    }
    .admin-column .api-token-section button:hover:not(:disabled) {
        background-color: #0056b3;
    }

    /* 通用表单行，用于款式名称和价格 */
    .admin-column .form-item-row {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    .admin-column .form-item-row label {
        margin-right: 10px;
    }
    .admin-column .form-item-row input {
        width: 100%;
    }

    /* 标签分组 */
    .admin-column .tag-group {
      margin-bottom: 15px;
    }
    .admin-column .tag-group-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .admin-column .tag-group-header label {
      margin-right: 10px;
    }
    .admin-column .tag-group-header input {
        width: 100%;
    }

    .admin-column .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
      min-height: 25px;
      border: 1px solid #eee;
      padding: 5px;
      border-radius: 4px;
    }

    .admin-column .tag-item {
      background-color: #e9ecef;
      color: #495057;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s, color 0.2s, opacity 0.2s;
    }

    .admin-column .tag-item.selected {
      background-color: #007bff;
      color: #fff;
    }
    /* 禁用状态的标签 */
    .admin-column .tag-item.disabled {
        pointer-events: none;
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* 通用按钮样式 */
    .admin-column #upload-btn {
      width: 100%; /* 让上传按钮更显眼 */
      background-color: #28a745;
      padding: 12px 20px;
    }
    .admin-column #upload-btn:hover:not(:disabled) {
      background-color: #218838;
    }

    /* 拖拽区域 */
    .admin-column #drop-area {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      margin: 10px 0 15px 0;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #f8f9fa;
      transition: background-color 0.2s;
    }
    .admin-column #drop-area.drag-over {
      background-color: #e0e0e0;
      border-color: #007bff;
    }
    .admin-column #drop-area p {
        margin: 0;
        color: #666;
    }
    .admin-column #file-list {
        margin-top: 10px;
        font-size: 0.9em;
        color: #555;
        max-height: 100px;
        overflow-y: auto;
        width: 100%;
        text-align: left;
        padding-left: 10px;
    }
    .admin-column #file-list p {
        margin: 2px 0;
    }

    /* 状态消息 */
    .admin-column #status-message {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .admin-column #status-message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .admin-column #status-message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Admin Selection Status */
    #admin-selection-status {
        margin-bottom: 20px;
        padding: 10px;
        border: 1px dashed #aed6f1; /* 轻蓝色边框 */
        border-radius: 5px;
        background-color: #e8f5fd; /* 轻蓝色背景 */
        font-size: 0.95em;
        color: #333;
        display: flex;
        flex-direction: column;
        align-items: center; /* 居中内容 */
        text-align: center;
    }
    #admin-selection-status p {
        margin-bottom: 10px;
        line-height: 1.4;
    }
    #admin-selection-status button {
        background-color: #dc3545; /* 红色按钮 */
        color: #fff;
        padding: 8px 15px;
        font-size: 0.9em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    #admin-selection-status button:hover:not(:disabled) {
        background-color: #c82333;
    }

    /* 媒体查询 */
    @media (max-width: 768px) {
        body {
            flex-direction: column; /* 小屏幕下改为垂直堆叠 */
        }
        .gallery-column, .detail-column, .admin-column {
            width: 100%;
            min-width: unset;
            flex: none;
        }
        .detail-column .product-detail-content {
            width: 90%; /* 移动端详情页宽度 */
            max-width: 400px;
            margin: 20px auto;
        }
    }
  </style>
</head>
<body>
  <div class="integrated-container">
    <!-- 左侧：服装展示画廊 -->
    <div class="gallery-column">
      <header>
        <div class="logo"><a href="#">李瑶的服装店</a></div>
        <nav id="main-nav">
          <div id="filter-style" class="filter-group"><strong>款式:</strong><div class="filter-tags"></div></div>
          <div id="filter-tag" class="filter-group"><strong>标签:</strong><div class="filter-tags"></div></div>
          <div id="filter-season" class="filter-group"><strong>季节:</strong><div class="filter-tags"></div></div>
          <div id="filter-scene" class="filter-group"><strong>场景:</strong><div class="filter-tags"></div></div>
        </nav>
      </header>

      <main>
          <section id="products-list" class="products">
              <!-- 商品卡片将动态加载到这里 -->
          </section>
          <p id="no-products-message" style="grid-column: 1 / -1; text-align: center; color: #888; display: none; padding: 40px 0;">未找到匹配的商品。</p>
      </main>

      <footer>
        <p>© 2025 李瑶的服装店. All rights reserved.</p>
      </footer>
    </div>

    <!-- 中间：商品详情页 (固定布局) -->
    <div class="detail-column">
        <div id="product-detail-view" class="product-detail-content">
            <!-- 商品详情将动态加载到这里 -->
        </div>
        <p class="placeholder-message" id="detail-placeholder">点击左侧商品查看详情</p>
    </div>

    <!-- 右侧：服装管理后台 -->
    <div class="admin-column">
      <div class="admin-container">
        <h1>服装图片管理后台</h1>

        <!-- 管理后台顶部区域：显示当前选择或提示 -->
        <div id="admin-selection-status">
            <p id="admin-selection-message">点击左侧商品选择，上传新图片到该商品；或输入信息创建新商品。</p>
            <button id="clear-admin-selection-btn" style="display: none;">取消选择</button>
        </div>

        <!-- API Token 管理区域 -->
        <div class="api-token-section">
            <label for="api-token">API Token:</label>
            <input type="text" id="api-token" placeholder="输入你的 API Token">
            <button id="save-api-token-btn">保存</button>
        </div>

        <!-- 商品基本信息输入 -->
        <div class="form-item-row">
          <label for="style-name">款式名称:</label>
          <input type="text" id="style-name" placeholder="例如：新款背心">
        </div>

        <div class="form-item-row">
          <label for="price">价格:</label>
          <input type="number" id="price" placeholder="例如：99">
        </div>

        <!-- 款式标签管理 -->
        <div class="tag-group">
          <div class="tag-group-header">
            <label>款式:</label>
            <input type="text" id="new-style" placeholder="添加新款式，按回车确认">
          </div>
          <div id="style-list" class="tag-list">
            <!-- 现有款式会动态添加到这里 -->
          </div>
        </div>

        <!-- 标签管理 -->
        <div class="tag-group">
          <div class="tag-group-header">
            <label>标签:</label>
            <input type="text" id="new-tag" placeholder="添加新标签，按回车确认">
          </div>
          <div id="tag-list" class="tag-list">
            <!-- 现有标签会动态添加到这里 -->
          </div>
        </div>

        <!-- 季节标签管理 -->
        <div class="tag-group">
          <div class="tag-group-header">
            <label>适用季节:</label>
            <input type="text" id="new-season" placeholder="添加新季节，按回车确认">
          </div>
          <div id="season-list" class="tag-list">
            <!-- 现有季节会动态添加到这里 -->
          </div>
        </div>

        <!-- 场景标签管理 -->
        <div class="tag-group">
          <div class="tag-group-header">
            <label>适用场景:</label>
            <input type="text" id="new-scene" placeholder="添加新场景，按回车确认">
          </div>
          <div id="scene-list" class="tag-list">
            <!-- 现有场景会动态添加到这里 -->
          </div>
        </div>

        <!-- 图片选择与拖拽区域 -->
        <label for="image">选择图片 (可拖拽):</label>
        <input type="file" id="image" accept="image/*" multiple style="display: none;" onchange="handleFileSelect(this.files)">
        <div id="drop-area">
          <p id="drop-area-message">拖拽图片到这里或点击选择文件</p>
          <div id="file-list"></div>
        </div>

        <!-- 上传按钮 -->
        <button id="upload-btn">上传图片</button>

        <!-- 状态消息显示区域 -->
        <div id="status-message"></div>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="hidden">
    <span class="spinner"></span>
    加载中...
  </div>

  <script>
    // ==================== 全局常量和 DOM 元素引用 ====================
    const API_BASE_URL = 'https://img.liyao.sbs';
    const API_TOKEN_KEY = 'imgbed_api_token';

    // DOM 元素引用...
    const productsList = document.getElementById('products-list');
    const noProductsMessage = document.getElementById('no-products-message');
    const detailView = document.getElementById('product-detail-view');
    const detailPlaceholder = document.getElementById('detail-placeholder');
    const loadingOverlay = document.getElementById('loading-overlay');
    const apiTokenInput = document.getElementById('api-token');
    const apiTokenSaveButton = document.getElementById('save-api-token-btn');
    const styleNameInput = document.getElementById('style-name');
    const priceInput = document.getElementById('price');
    const newStyleInput = document.getElementById('new-style');
    const newTagInput = document.getElementById('new-tag');
    const newSeasonInput = document.getElementById('new-season');
    const newSceneInput = document.getElementById('new-scene');
    const dropArea = document.getElementById('drop-area');
    const dropAreaMessage = document.getElementById('drop-area-message'); // 新增 DOM 引用
    const fileListDiv = document.getElementById('file-list');
    const uploadButton = document.getElementById('upload-btn');
    const statusMessageDiv = document.getElementById('status-message');
    const adminSelectionStatus = document.getElementById('admin-selection-status');
    const adminSelectionMessage = document.getElementById('admin-selection-message');
    const clearAdminSelectionBtn = document.getElementById('clear-admin-selection-btn');

    // ==================== 全局状态变量 ====================
    let allProducts = [];
    let currentSelectedProductForAdmin = null; // 存储当前在管理后台选中的商品对象
    
    // 用于画廊筛选
    let activeFilters = { 
        style: new Set(),
        tag: new Set(),
        season: new Set(),
        scene: new Set()
    };
    
    // 用于 "创建新商品" 模式下存储用户选择
    let createModeSelectedTags = {
        styles: new Set(),
        tags: new Set(),
        seasons: new Set(),
        scenes: new Set()
    };
    
    // 存储从所有商品中收集到的所有可能的标签值
    let allPossibleTags = {
        styles: [],
        tags: [],
        seasons: [],
        scenes: []
    };

    let filesToUpload = [];


    // ==================== 数据获取与解析 ====================
    async function fetchAllProducts() {
        showLoading();
        try {
            const apiToken = localStorage.getItem(API_TOKEN_KEY);
            if (!apiToken) throw new Error("API Token 未设置。请在管理后台输入并保存。");
            
            const response = await fetch(`${API_BASE_URL}/api/manage/list?dir=服装&count=-1&recursive=true`, {
                headers: { 'Authorization': `Bearer ${apiToken}` }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`获取商品列表失败：${response.status} - ${errorData.error || response.statusText}`);
            }

            const data = await response.json();
            const { directories = [], files = [] } = data;
            const productMap = new Map();

            directories.forEach(dirPath => {
                const folderName = dirPath.split('/').pop();
                const parsedInfo = parseFolderName(folderName);
                if (parsedInfo) {
                    productMap.set(dirPath, {
                        id: dirPath.replace(/[\/\.]/g, '_').replace(/-/g, '__'),
                        path: dirPath,
                        ...parsedInfo,
                        priceNum: parseFloat(parsedInfo.price.replace('¥', '')) || 0,
                        images: []
                    });
                }
            });

            files.forEach(file => {
                const productDirPath = file.name.substring(0, file.name.lastIndexOf('/'));
                if (productMap.has(productDirPath)) {
                    productMap.get(productDirPath).images.push({
                        src: `${API_BASE_URL}/file/${file.name}`,
                        fileName: file.name.split('/').pop()
                    });
                }
            });

            allProducts = Array.from(productMap.values()).filter(p => p.images.length > 0);
            allProducts.forEach(p => p.images.sort((a, b) => a.fileName.localeCompare(b.fileName)));

            populateFiltersAndTags(); // 确保在渲染商品和管理标签前，allPossibleTags已更新
            applyFilters();
        } catch (error) {
            console.error("加载商品数据失败:", error);
            showStatusMessage(`加载商品数据失败: ${error.message}`, 'error');
            productsList.innerHTML = '';
            noProductsMessage.style.display = 'block';
            noProductsMessage.textContent = `加载商品失败，请检查API Token或网络连接。`;
        } finally {
            hideLoading();
        }
    }

    function parseFolderName(folderName) {
        const parts = folderName.split('-');
        // 确保文件夹名至少包含价格、款式、标签、季节、场景、名称六部分
        if (parts.length < 6 || isNaN(parseInt(parts[0]))) return null;
        return {
            price: `¥${parts[0]}`,
            styles: parts[1].split('_').filter(Boolean),
            tags: parts[2].split('_').filter(Boolean),
            seasons: parts[3].split('_').filter(Boolean),
            scenes: parts[4].split('_').filter(Boolean),
            name: parts.slice(5).join('-')
        };
    }

    // ==================== 筛选器与标签池 ====================
    function populateFiltersAndTags() {
        const filters = { style: new Set(), tag: new Set(), season: new Set(), scene: new Set() };
        // 重置 allPossibleTags 为 Set，以便收集唯一值
        allPossibleTags = { styles: new Set(), tags: new Set(), seasons: new Set(), scenes: new Set() };

        allProducts.forEach(p => {
            p.styles.forEach(s => { filters.style.add(s); allPossibleTags.styles.add(s); });
            p.tags.forEach(t => { filters.tag.add(t); allPossibleTags.tags.add(t); });
            p.seasons.forEach(s => { filters.season.add(s); allPossibleTags.seasons.add(s); });
            p.scenes.forEach(s => { filters.scene.add(s); allPossibleTags.scenes.add(s); });
        });
        
        // 将 Set 转换为排序后的数组，并更新全局 allPossibleTags
        for (const key in allPossibleTags) {
            allPossibleTags[key] = Array.from(allPossibleTags[key]).sort();
        }

        for (const type in filters) {
            const container = document.querySelector(`#filter-${type} .filter-tags`);
            if (container) {
                renderFilterGroup(container, Array.from(filters[type]).sort(), type);
            }
        }
        // 初始化 admin 区域的标签列表为可编辑状态
        renderAdminTagsInCreateMode();
    }

    function renderFilterGroup(container, items, filterType) {
        container.innerHTML = '';
        ['全部', ...items].forEach(item => {
            const tagLink = document.createElement('a');
            tagLink.className = 'filter-tag';
            tagLink.textContent = item;
            if ((item === '全部' && activeFilters[filterType].size === 0) || activeFilters[filterType].has(item)) {
                tagLink.classList.add('active');
            }
            tagLink.onclick = () => {
                if (item === '全部') activeFilters[filterType].clear();
                else activeFilters[filterType].has(item) ? activeFilters[filterType].delete(item) : activeFilters[filterType].add(item);
                applyFilters();
                populateFiltersAndTags(); // 重绘以更新激活状态，确保筛选器显示正确
            };
            container.appendChild(tagLink);
        });
    }

    function applyFilters() {
        const filteredProducts = allProducts.filter(product => {
            return ['style', 'tag', 'season', 'scene'].every(type => {
                if (activeFilters[type].size === 0) return true;
                return product[`${type}s`].some(attr => activeFilters[type].has(attr));
            });
        });
        renderProducts(filteredProducts);
    }

    // ==================== 渲染逻辑 ====================
    function renderProducts(products) {
        productsList.innerHTML = '';
        noProductsMessage.style.display = products.length === 0 ? 'block' : 'none';
        if (products.length > 0) noProductsMessage.textContent = '未找到匹配的商品。';

        products.forEach(product => {
            const productCard = document.createElement('article');
            productCard.className = 'product-card';
            productCard.innerHTML = `
                <a href="#">
                    <img src="${product.images.length > 0 ? product.images[0].src : ''}" alt="${product.name}" loading="lazy">
                    <div class="product-info">
                        <div class="product-name-price">
                            <p class="price">${product.price}</p>
                            <h2>${product.name}</h2>
                        </div>
                        <div class="product-season">${product.seasons.map(s => `<span>${s}</span>`).join('')}</div>
                        <div class="product-tags">${product.tags.map(t => `<span>${t}</span>`).join('')}</div>
                    </div>
                </a>
            `;
            productCard.onclick = (e) => {
                e.preventDefault();
                displayProductDetails(product);
            };
            productsList.appendChild(productCard);
        });
    }

    function displayProductDetails(product) {
        // 1. 显示详情
        const imagesHtml = product.images.map(img => `<img src="${img.src}" alt="${product.name}" loading="lazy">`).join('');
        detailView.innerHTML = `
            <div class="modal-nav">
                <a href="#" class="back-button" onclick="hideProductDetail()"></a>
                <div class="product-title">${product.name}</div>
                <div class="modal-nav-price">${product.price}</div>
            </div>
            <div class="modal-content-inner">
                ${imagesHtml}
                <p class="modal-description">
                    ${product.styles.length > 0 ? `<strong>款式:</strong> ${product.styles.join(', ')}<br>` : ''}
                    ${product.tags.length > 0 ? `<strong>标签:</strong> ${product.tags.join(', ')}<br>` : ''}
                    ${product.seasons.length > 0 ? `<strong>季节:</strong> ${product.seasons.join(', ')}<br>` : ''}
                    ${product.scenes.length > 0 ? `<strong>场景:</strong> ${product.scenes.join(', ')}` : ''}
                </p>
            </div>
        `;
        detailView.classList.add('active');
        detailPlaceholder.style.display = 'none';

        // 2. 填充并锁定管理区域
        loadProductIntoAdminForm(product);
    }
    
    function hideProductDetail() {
        detailView.classList.remove('active');
        detailView.innerHTML = '';
        detailPlaceholder.style.display = 'block';
    }

    // ==================== Admin 表单管理与交互 (核心逻辑) ====================
    function loadProductIntoAdminForm(product) {
        currentSelectedProductForAdmin = product;

        // 填充基本信息，这些输入框将被禁用
        styleNameInput.value = product.name;
        priceInput.value = product.priceNum;

        // 渲染管理区域的标签为 "显示模式" (非交互)
        renderAdminTagsInDisplayMode(product);
        
        // 设置管理后台表单状态为锁定，并更新拖拽区域的提示信息
        setAdminFormState(true, product);
    }

    function clearAdminProductSelection() {
        currentSelectedProductForAdmin = null;
        styleNameInput.value = '';
        priceInput.value = '';
        
        // 清空 "创建模式" 的已选标签
        for(const key in createModeSelectedTags) {
            createModeSelectedTags[key].clear();
        }
        
        filesToUpload = []; // 清空待上传文件列表
        updateFileListDisplay(); // 更新文件列表显示并相应地禁用/启用上传按钮
        
        // 渲染管理区域的标签为 "创建/编辑模式" (可交互)
        renderAdminTagsInCreateMode();

        setAdminFormState(false); // 解锁表单，并更新拖拽区域的提示信息
        showStatusMessage('已清除商品选择，可以输入信息创建新商品。', '');
    }

    /**
     * 根据产品数据显示标签 (锁定状态)
     */
    function renderAdminTagsInDisplayMode(product) {
        renderSingleAdminTagGroup('style-list', allPossibleTags.styles, product.styles);
        renderSingleAdminTagGroup('tag-list', allPossibleTags.tags, product.tags);
        renderSingleAdminTagGroup('season-list', allPossibleTags.seasons, product.seasons);
        renderSingleAdminTagGroup('scene-list', allPossibleTags.scenes, product.scenes);
    }

    /**
     * 渲染可交互的标签 (创建模式)
     */
    function renderAdminTagsInCreateMode() {
        renderSingleAdminTagGroup('style-list', allPossibleTags.styles, createModeSelectedTags.styles, true, 'styles');
        renderSingleAdminTagGroup('tag-list', allPossibleTags.tags, createModeSelectedTags.tags, true, 'tags');
        renderSingleAdminTagGroup('season-list', allPossibleTags.seasons, createModeSelectedTags.seasons, true, 'seasons');
        renderSingleAdminTagGroup('scene-list', allPossibleTags.scenes, createModeSelectedTags.scenes, true, 'scenes');
    }

    /**
     * 渲染单个 admin 标签组的通用函数
     * @param {string} containerId - 容器元素的ID
     * @param {string[]} allItems - 该分类所有可能的标签 (来自 allPossibleTags)
     * @param {string[]|Set} selectedItems - 已选中的标签 (可能是产品已有的，或创建模式下用户选择的)
     * @param {boolean} isEditable - 是否可编辑 (创建模式)
     * @param {string} categoryKey - 'styles', 'tags' 等, 用于在编辑模式下更新状态
     */
    function renderSingleAdminTagGroup(containerId, allItems, selectedItems, isEditable = false, categoryKey = '') {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const selectedSet = new Set(selectedItems); // 统一处理 Array 和 Set

        allItems.forEach(item => {
            const tagDiv = document.createElement('div');
            tagDiv.className = 'tag-item';
            tagDiv.textContent = item;

            if (selectedSet.has(item)) {
                tagDiv.classList.add('selected');
            }

            if (!isEditable) {
                tagDiv.classList.add('disabled'); // 在显示模式下，标签不可交互
            } else {
                tagDiv.onclick = () => {
                    const currentSelections = createModeSelectedTags[categoryKey];
                    if (currentSelections.has(item)) {
                        currentSelections.delete(item);
                        tagDiv.classList.remove('selected');
                    } else {
                        currentSelections.add(item);
                        tagDiv.classList.add('selected');
                    }
                };
            }
            container.appendChild(tagDiv);
        });
    }

    /**
     * 设置管理后台表单的启用/禁用状态，并更新提示信息
     * @param {boolean} locked - 是否锁定表单 (true for selecting an existing product)
     * @param {object|null} product - 当前选中的产品对象
     */
    function setAdminFormState(locked, product = null) {
        // 禁用/启用款式名称、价格和新增标签的输入框
        [styleNameInput, priceInput, newStyleInput, newTagInput, newSeasonInput, newSceneInput].forEach(el => el.disabled = locked);

        if (locked && product) {
            adminSelectionMessage.innerHTML = `当前已选择商品：<strong>${product.name}</strong><br>所有上传的图片将添加到此商品。`;
            clearAdminSelectionBtn.style.display = 'inline-block';
            dropAreaMessage.textContent = `拖拽图片或点击选择文件，将上传到“${product.name}”`; // 明确提示上传目标
        } else {
            adminSelectionMessage.textContent = '点击左侧商品选择，上传新图片到该商品；或输入信息创建新商品。';
            clearAdminSelectionBtn.style.display = 'none';
            dropAreaMessage.textContent = '拖拽图片到这里或点击选择文件'; // 恢复默认提示
        }
    }
    
    function handleFileSelect(files) {
      filesToUpload.push(...Array.from(files));
      updateFileListDisplay();
    }
    function updateFileListDisplay() {
        fileListDiv.innerHTML = filesToUpload.length > 0 
            ? `<p>已选择 ${filesToUpload.length} 个文件:</p>` + filesToUpload.map(f => `<p>${f.name}</p>`).join('')
            : '<p>无文件待上传</p>';
        uploadButton.disabled = filesToUpload.length === 0; // 上传按钮只在有文件时启用
    }
    dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('drag-over'); });
    dropArea.addEventListener('dragleave', e => { e.preventDefault(); dropArea.classList.remove('drag-over'); });
    dropArea.addEventListener('drop', e => { e.preventDefault(); dropArea.classList.remove('drag-over'); handleFileSelect(e.dataTransfer.files); });
    dropArea.addEventListener('click', () => document.getElementById('image').click());

    async function uploadImages() {
        const apiToken = apiTokenInput.value.trim();
        if (!apiToken) { showStatusMessage('请填写 API Token！', 'error'); return; }
        if (filesToUpload.length === 0) { showStatusMessage('请选择要上传的文件！', 'error'); return; }

        let uploadFolder = '';
        if (currentSelectedProductForAdmin) {
            // 如果已选择商品，上传到该商品的目录
            uploadFolder = currentSelectedProductForAdmin.path;
        } else {
            // 否则，创建新商品
            const name = styleNameInput.value.trim();
            const price = priceInput.value.trim();
            // 在这里使用 `createModeSelectedTags` 而不是 `allPossibleTags`，因为 allPossibleTags 包含所有可能标签，createModeSelectedTags 包含用户为新产品选择的标签
            const styles = Array.from(createModeSelectedTags.styles).join('_');
            const tags = Array.from(createModeSelectedTags.tags).join('_');
            const seasons = Array.from(createModeSelectedTags.seasons).join('_');
            const scenes = Array.from(createModeSelectedTags.scenes).join('_');

            if (!name || !price || !styles || !tags || !seasons || !scenes) {
                showStatusMessage('创建新商品时，名称、价格和各类标签都必须填写/选择。', 'error');
                return;
            }
            uploadFolder = `服装/${price}-${styles}-${tags}-${seasons}-${scenes}-${name}`;
        }
        
        uploadButton.disabled = true;
        uploadButton.textContent = '上传中...';
        let successCount = 0;
        let failCount = 0;
        
        for (const file of filesToUpload) {
            const success = await uploadSingleImage(file, uploadFolder, apiToken);
            if (success) successCount++;
            else failCount++;
        }
        
        let finalMessage = `上传完成。成功：${successCount}，失败：${failCount}。`;
        showStatusMessage(finalMessage, failCount > 0 ? 'error' : 'success');
        
        filesToUpload = []; // 清空待上传文件列表
        updateFileListDisplay(); // 更新显示，上传按钮会再次禁用
        uploadButton.textContent = '上传图片';

        // 刷新画廊以显示新上传的图片或商品
        resetAndLoad();
    }
    
    async function uploadSingleImage(file, uploadFolder, apiToken) {
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch(`${API_BASE_URL}/upload?uploadFolder=${encodeURIComponent(uploadFolder)}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiToken}` },
                body: formData
            });
            if (!response.ok) throw new Error(`服务器错误: ${response.statusText}`);
            return true;
        } catch (error) {
            console.error(`上传 "${file.name}" 失败:`, error);
            // 可以在这里细化错误处理，例如记录哪个文件失败了
            return false;
        }
    }


    // ==================== 通用函数与事件监听 ====================
    function showLoading() { if (loadingOverlay) loadingOverlay.classList.remove('hidden'); }
    function hideLoading() { if (loadingOverlay) loadingOverlay.classList.add('hidden'); }
    function showStatusMessage(message, type) {
      statusMessageDiv.textContent = message;
      statusMessageDiv.className = type;
      statusMessageDiv.style.display = 'block';
    }

    function resetAndLoad() {
        activeFilters = { style: new Set(), tag: new Set(), season: new Set(), scene: new Set() };
        clearAdminProductSelection();
        fetchAllProducts();
        hideProductDetail();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const storedToken = localStorage.getItem(API_TOKEN_KEY);
        if (storedToken) apiTokenInput.value = storedToken;
        
        resetAndLoad(); // 页面加载后立即重置并加载数据

        document.querySelector('.logo a').addEventListener('click', e => { e.preventDefault(); resetAndLoad(); });
        clearAdminSelectionBtn.addEventListener('click', clearAdminProductSelection);
        apiTokenSaveButton.addEventListener('click', () => {
            localStorage.setItem(API_TOKEN_KEY, apiTokenInput.value);
            showStatusMessage('API Token 已保存。', 'success');
            resetAndLoad(); // 保存后立即刷新，重新加载数据
        });
        
        // 为新标签输入框添加回车事件，修正闭包bug
        const setupNewTagInput = (inputId, categoryKey) => { // 移除allTagsArray参数
            document.getElementById(inputId).addEventListener('keyup', (event) => {
                // 只有在未选择现有商品 (即创建新商品模式) 且按下回车键时才响应
                if (event.key === 'Enter' && !currentSelectedProductForAdmin) {
                    const input = event.target;
                    const newTag = input.value.trim();
                    if (newTag) {
                        // 直接从全局 allPossibleTags 对象获取最新引用
                        const currentAllTagsForCategory = allPossibleTags[categoryKey]; 
                        if (!currentAllTagsForCategory.includes(newTag)) {
                            currentAllTagsForCategory.push(newTag);
                            currentAllTagsForCategory.sort();
                        }
                        // 同时将新标签添加到当前创建中的商品的选择列表
                        createModeSelectedTags[categoryKey].add(newTag);
                        input.value = ''; // 清空输入框
                        renderAdminTagsInCreateMode(); // 重新渲染以显示新标签并选中
                    }
                }
            });
        };
        // 调用时不再传递第三个参数
        setupNewTagInput('new-style', 'styles');
        setupNewTagInput('new-tag', 'tags');
        setupNewTagInput('new-season', 'seasons');
        setupNewTagInput('new-scene', 'scenes');

        uploadButton.addEventListener('click', uploadImages); // 绑定上传按钮点击事件
    });
  </script>
</body>
</html>