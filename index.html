<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>李瑶的服装店</title>
  <style>
    /* CSS Reset (Simplified) - 基础样式重置 */
    body, h1, h2, h3, p, ul, li, figure {
      margin: 0;
      padding: 0;
      border: 0;
      font-size: 100%;
      font: inherit;
      vertical-align: baseline;
      box-sizing: border-box; /* 非常重要：让padding和border包含在元素总宽度和高度内 */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      line-height: 1.6;
      background-color: #f4f4f4;
      color: #333;
    }

    ul {
      list-style: none; /* 移除列表默认点 */
    }

    a {
      text-decoration: none; /* 移除链接下划线 */
      color: inherit; /* 链接颜色继承父级 */
    }

    img {
      max-width: 100%; /* 图片不超过父容器 */
      display: block; /* 移除图片底部空白 */
    }

    /* 页面布局 */
    .container {
      margin: 0 auto;
      padding: 5px;
    }

    header {
      background-color: #fff;
      padding: 15px 0;
      text-align: center;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* 轻微阴影 */
    }

    header .logo {
      font-size: 1.8rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }

    /* 导航样式 - 根据新的筛选需求重新设计 */
    nav {
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    
    /* [修复 1] 使用 Flexbox 让 Label 和标签在同一行 */
    .filter-group {
      margin-bottom: 10px;
      padding: 0 10px;
      display: flex;
      align-items: center; /* 垂直居中对齐 */
      flex-wrap: wrap; /* 允许标签换行 */
    }
    .filter-group strong {
        color: #555;
        font-size: 0.9em;
        margin-right: 8px; /* Label 和标签之间的间距 */
        flex-shrink: 0; /* 防止 Label 被压缩 */
    }

    nav .filter-tags { /* 用于包裹标签的 flex 容器 */
        display: flex;
        flex-wrap: wrap; /* 允许标签换行 */
        gap: 8px; /* 标签间距 */
    }

    nav a.filter-tag {
        display: inline-block;
        padding: 4px 8px;
        background-color: #e9ecef; /* 默认背景色 */
        color: #495057; /* 默认文字颜色 */
        border-radius: 5px; /* 圆角标签 */
        font-size: 0.85rem;
        transition: background-color 0.2s, color 0.2s;
        flex-shrink: 0; /* 防止标签挤压 */
        cursor: pointer; /* 确保可点击 */
    }

    nav a.filter-tag.active { /* 选中状态 */
      background-color: #00aaff;
      color: #fff;
    }
    nav a.filter-tag:hover:not(.active) { /* 悬停效果 (未选中时) */
        background-color: #d8dee3;
    }


    /* 商品列表 */
    .products {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(45%, 1fr)); /* 移动端双排 */
      gap: 5px; /* 商品卡片之间间距 */
    }

    .product-card {
      background-color: #fff;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease-in-out;
      display: flex; /* Flexbox 使得内容可以向下布局 */
      flex-direction: column;
      height: 100%; /* 确保卡片高度一致 */
    }

    .product-card:hover { /* 悬停效果 */
      transform: translateY(-5px);
    }

    .product-card img {
      width: 100%;
      height: auto; 
      aspect-ratio: 3 / 4; /* 维持 3:4 的宽高比 */
      object-fit: cover; /* 保持图片比例，裁剪填充 */
      object-position: center; /* 保证图片居中显示,避免裁剪失真*/
    }

    .product-info {
        padding: 10px;
        flex-grow: 1; /* 内容占据剩余空间 */
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* 使得底部信息与顶部图片有间距 */
    }

    .product-name-price {
        display: flex;
        justify-content: space-between;
        align-items: baseline; /* 价格和名称基线对齐 */
        margin-bottom: 5px;
    }

    .product-name-price h2 { /* 商品名称 */
      font-size: 1.1rem;
      font-weight: bold;
      margin: 0;
      flex-grow: 1; /* 占据剩余空间 */
      line-height: 1.3;
      overflow: hidden; /* 防止文字溢出 */
      text-overflow: ellipsis; /* 文字溢出时显示省略号 */
      display: -webkit-box;
      -webkit-line-clamp: 2; /* 限制2行 */
      -webkit-box-orient: vertical;
    }

    .product-name-price .price { /* 商品价格 */
      font-size: 1.1rem;
      font-weight: bold;
      color: #e64a19; /* 显眼的价格颜色 */
      margin-right: 10px; /* 价格与名称间距 */
      flex-shrink: 0; /* 防止价格被挤压 */
    }

    .product-tags, .product-season {
        font-size: 0.65rem;
        color: #777;
        margin-bottom: 3px;
    }
    
    .product-tags span, .product-season span {
        display: inline-block;
        margin-right: 5px;
        padding: 2px 6px;
        border-radius: 3px;
    }

    .product-tags span {
        background-color: #f7f7df;
    }

    .product-season span {
        background-color: #e1f5ff;
    }

    .product-season {
        margin-top: auto; /* 推到最底部 */
        padding-top: 5px;
        border-top: 1px dashed #eee;
    }


    /* 模态框 (Modal) */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      display: none; /* 初始隐藏 */
      flex-direction: column; /* 垂直布局，顶部导航和内容 */
      z-index: 1000;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0;
    }
    .modal.active {
        display: flex;
    }

    .modal-nav {
        position: sticky; /* 顶部悬浮 */
        top: 0;
        left: 0;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.95); /* 半透明白色背景 */
        backdrop-filter: blur(5px); /* 毛玻璃效果 */
        -webkit-backdrop-filter: blur(5px); /* Safari 支持 */
        z-index: 1001;
        display: flex;
        align-items: center;
        justify-content: space-between; /* 左右对齐 */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .modal-nav .back-button {
        font-size: 1rem;
        font-weight: normal;
        color: #333;
        text-decoration: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: 5px;
        transition: background-color 0.2s;
        flex-shrink: 0; /* 防止被挤压 */
    }
    .modal-nav .back-button::before {
        content: '←';
        font-size: 1.4rem;
        line-height: 1;
    }

    .modal-nav .product-title {
        flex-grow: 1; /* 占据所有可用空间 */
        text-align: center; /* 文本居中 */
        font-size: 1.1rem;
        font-weight: bold;
        color: #333;
        white-space: nowrap; /* 防止文字换行 */
        overflow: hidden;
        text-overflow: ellipsis;
        /* 移除绝对定位相关样式 */
    }

    /* 新增一个右侧占位元素，与返回按钮宽度相同 */
    .modal-nav .right-placeholder {
        visibility: hidden; /* 隐藏但保留空间 */
        /* 复制 back-button 的样式以确保宽度一致 */
        font-size: 1rem;
        font-weight: normal;
        color: #333;
        text-decoration: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: 5px;
        flex-shrink: 0;
    }
    .modal-nav .right-placeholder::before {
        content: '←';
        font-size: 1.2rem;
        line-height: 1;
    }
    /* 新增模态框导航栏中的价格样式 */
    .modal-nav .modal-nav-price {
        font-size: 1.1rem;
        font-weight: bold;
        color: #e64a19; /* 显眼的价格颜色 */
        margin-left: 10px; /* 与名称的间距 */
        flex-shrink: 0; /* 防止价格被挤压 */
        padding: 5px 10px; /* 与返回按钮保持一致的内边距 */
        border-radius: 5px; /* 与返回按钮保持一致的圆角 */
    }

    .modal-content {
      max-width: 100%;
      min-width: 300px;
      max-height: calc(100% - 60px); /* 减去导航栏高度 */
      position: relative;
      margin: 0 auto; /* 居中显示 */
      padding-top: 10px; /* 留出顶部导航栏的空间 */
      flex-grow: 1; /* 占据剩余空间 */
      overflow-y: auto; /* 内容可滚动 */
    }

    .modal-content img {
      width: 100%;
      height: auto;
    }

    /* 移除旧的 modal-close 样式 */
    /* .modal-close { ... } */

    .modal-header {
      margin-bottom: 10px;
      padding-top: 10px;
    }
    .modal-header h3 {
        font-size: 1.4rem;
        font-weight: bold;
        color: #333;
    }
    .modal-price {
        font-size: 1.3rem;
        font-weight: bold;
        color: #e64a19;
        margin-top: 5px;
        margin-bottom: 10px;
    }
    .modal-description {
        font-size: 0.95rem;
        color: #555;
        margin-top: 15px;
        padding: 10px;
        border-top: 1px dashed #eee;
    }


    footer {
      text-align: center;
      margin-top: 10px;
      padding: 5px 0;
      background-color: #ddd;
      position: absolute;
      font-size: smaller;
      font-weight: light;
      bottom: 0;
      left: 0;
      right: 0;
    }

    /* 加载状态 */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        font-size: 1.2rem;
        color: #007bff;
        text-align: center;
    }
    #loading-overlay span.spinner {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        border: 0.25rem solid rgba(0,0,0,.15);
        border-right-color: #007bff;
        border-radius: 50%;
        animation: spinner-border .75s linear infinite;
        margin-bottom: 10px;
    }
    @keyframes spinner-border {
        to { transform: rotate(360deg); }
    }
    
    #loading-overlay.hidden {
        display: none;
    }

    /* 媒体查询 */
    @media (min-width: 768px) {
      .container { max-width: 960px; }
      .products { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
      .modal-content { max-width: 700px; }
    }
    @media (min-width: 992px) { .container { max-width: 1200px; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo"><a href="#">李瑶的服装店</a></div>
      <nav id="main-nav">
        <!-- 导航筛选器将动态加载到这里 -->
        <div id="filter-style" class="filter-group"><strong>款式:</strong><div class="filter-tags"></div></div>
        <div id="filter-tag" class="filter-group"><strong>标签:</strong><div class="filter-tags"></div></div>
        <div id="filter-season" class="filter-group"><strong>季节:</strong><div class="filter-tags"></div></div>
        <div id="filter-scene" class="filter-group"><strong>场景:</strong><div class="filter-tags"></div></div>
      </nav>
    </header>

    <main>
        <section id="products-list" class="products">
            <!-- 商品卡片将动态加载到这里 -->
        </section>
        <p id="no-products-message" style="grid-column: 1 / -1; text-align: center; color: #888; display: none; padding: 40px 0;">未找到匹配的商品。</p>

        <!-- 模态框容器 -->
        <div id="modal-container">
            <!-- 模态框将动态创建到这里 -->
        </div>
    </main>

    <footer>
      <p>© 2025 李瑶的服装店. All rights reserved.</p>
    </footer>
  </div>

  <div id="loading-overlay" class="hidden">
    <span class="spinner"></span>
    加载中...
  </div>

  <script>
    const API_BASE_URL = 'https://img.liyao.sbs';
    const API_TOKEN = 'imgbed_5pv5JE1P2Z4ZnYDicuZzsHzBfMlzy2rz';

    let allProducts = [];
    let activeFilters = {
        style: new Set(),
        tag: new Set(),
        season: new Set(),
        scene: new Set()
    };
    
    // --- 数据获取与解析 ---
    async function fetchAllProducts() {
        showLoading();
        try {
            const response = await fetch(`${API_BASE_URL}/api/manage/list?dir=服装&count=-1&recursive=true`, {
                headers: { 'Authorization': `Bearer ${API_TOKEN}` }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`获取商品列表失败：${response.status} - ${errorData.error || response.statusText}`);
            }

            const data = await response.json();
            const { directories = [], files = [] } = data;
            const productMap = new Map();

            directories.forEach(dirPath => {
                const folderName = dirPath.split('/').pop();
                const parsedInfo = parseFolderName(folderName);
                if (parsedInfo) {
                    productMap.set(dirPath, {
                        id: dirPath.replace(/[\/\.]/g, '_').replace(/-/g, '__'),
                        path: dirPath,
                        ...parsedInfo,
                        price: parseFloat(parsedInfo.price.replace('¥', '')) || 0,
                        images: []
                    });
                }
            });

            files.forEach(file => {
                const productDirPath = file.name.substring(0, file.name.lastIndexOf('/'));
                if (productMap.has(productDirPath)) {
                    productMap.get(productDirPath).images.push({
                        src: `${API_BASE_URL}/file/${file.name}`,
                        fileName: file.name.split('/').pop()
                    });
                }
            });

            allProducts = Array.from(productMap.values()).filter(p => p.images.length > 0);
            allProducts.forEach(p => p.images.sort((a, b) => a.fileName.localeCompare(b.fileName)));

            populateFilters();
            applyFilters();
        } catch (error) {
            console.error("加载商品数据失败:", error);
            alert(`加载商品数据失败：${error.message}`);
        } finally {
            hideLoading();
        }
    }

    function parseFolderName(folderName) {
        const parts = folderName.split('-');
        if (parts.length < 6 || isNaN(parseInt(parts[0]))) return null;

        return {
            price: `¥${parts[0]}`,
            styles: parts[1].split('_').filter(Boolean),
            tags: parts[2].split('_').filter(Boolean),
            seasons: parts[3].split('_').filter(Boolean),
            scenes: parts[4].split('_').filter(Boolean),
            name: parts.slice(5).join('-')
        };
    }

    // --- 筛选器逻辑 ---
    function populateFilters() {
        const filters = { style: new Set(), tag: new Set(), season: new Set(), scene: new Set() };
        allProducts.forEach(p => {
            p.styles.forEach(s => filters.style.add(s));
            p.tags.forEach(t => filters.tag.add(t));
            p.seasons.forEach(s => filters.season.add(s));
            p.scenes.forEach(s => filters.scene.add(s));
        });

        for (const type in filters) {
            const container = document.querySelector(`#filter-${type} .filter-tags`);
            if (container) {
                renderFilterGroup(container, Array.from(filters[type]).sort(), type);
            }
        }
    }

    function renderFilterGroup(container, items, filterType) {
        container.innerHTML = '';
        ['全部', ...items].forEach(item => {
            const tagLink = document.createElement('a');
            tagLink.className = 'filter-tag';
            tagLink.textContent = item;
            
            if (item === '全部' && activeFilters[filterType].size === 0) {
                tagLink.classList.add('active');
            } else if (activeFilters[filterType].has(item)) {
                tagLink.classList.add('active');
            }

            tagLink.onclick = () => {
                if (item === '全部') {
                    activeFilters[filterType].clear();
                } else {
                    activeFilters[filterType].has(item) ?
                        activeFilters[filterType].delete(item) :
                        activeFilters[filterType].add(item);
                }
                applyFilters();
                populateFilters(); // Re-render all filters to update active states
            };
            container.appendChild(tagLink);
        });
    }

    // [修复 2] 修正筛选逻辑
    function applyFilters() {
        const filteredProducts = allProducts.filter(product => {
            // 遍历所有筛选类别 (style, tag, season, scene)
            return Object.entries(activeFilters).every(([type, filterSet]) => {
                // 如果这个类别的筛选器没有被激活，则认为该商品通过此项检查
                if (filterSet.size === 0) {
                    return true;
                }
                // 否则，检查商品的属性数组中是否至少有一个元素存在于筛选集合中
                const productAttributes = product[`${type}s`]; // e.g., product.styles
                return productAttributes.some(attribute => filterSet.has(attribute));
            });
        });
        renderProducts(filteredProducts);
    }


    // --- 渲染逻辑 ---
    function renderProducts(products) {
        const productsList = document.getElementById('products-list');
        const noProductsMessage = document.getElementById('no-products-message');
        productsList.innerHTML = '';
        document.getElementById('modal-container').innerHTML = ''; // 清空旧模态框

        noProductsMessage.style.display = products.length === 0 ? 'block' : 'none';

        products.forEach(product => {
            const modalId = `modal-${product.id}`;
            const productCard = document.createElement('article');
            productCard.className = 'product-card';
            // [修复 3] 改用 onclick 事件
            productCard.innerHTML = `
                <a href="#${modalId}" onclick="event.preventDefault(); openModal('${modalId}');">
                    <img src="${product.images.length > 0 ? product.images[0].src : ''}" alt="${product.name}" loading="lazy">
                    <div class="product-info">
                        <div class="product-name-price">
                            <p class="price">¥${product.price}</p>
                            <h2>${product.name}</h2>
                        </div>
                        <div class="product-season">${product.seasons.length > 0 ?  product.seasons.map(s => `<span>${s}</span>`).join('') : ''}</div>
                        <div class="product-tags">${product.tags.length > 0 ?  product.tags.map(t => `<span>${t}</span>`).join('') : ''}</div>
                    </div>
                </a>
            `;
            productsList.appendChild(productCard);
            createProductModal(product, modalId);
        });
    }

    function createProductModal(product, modalId) {
        const modalContainer = document.getElementById('modal-container');
        const modalDiv = document.createElement('div');
        modalDiv.className = 'modal';
        modalDiv.id = modalId;

        const imagesHtml = product.images.map(img => `<img src="${img.src}" alt="${product.name}" loading="lazy">`).join('');
        
        modalDiv.innerHTML = `
            <div class="modal-nav">
                <a href="#" class="back-button" onclick="closeModal('${modalId}')"></a>
                <div class="product-title">
                    ${product.name}
                </div>
                <div class="modal-nav-price">¥${product.price}</div>
            </div>
            <div class="modal-content">
                ${imagesHtml}
                <div class="modal-header">
                    <!-- <h3>${product.name}</h3> -->
                    <!-- <p class="modal-price">¥${product.price}</p> -->
                </div>
                <p class="modal-description">
                    ${product.styles.length > 0 ? `<strong>款式:</strong> ${product.styles.join(', ')}<br>` : ''}
                    ${product.tags.length > 0 ? `<strong>标签:</strong> ${product.tags.join(', ')}<br>` : ''}
                    ${product.seasons.length > 0 ? `<strong>季节:</strong> ${product.seasons.join(', ')}<br>` : ''}
                    ${product.scenes.length > 0 ? `<strong>场景:</strong> ${product.scenes.join(', ')}` : ''}
                </p>
            </div>
        `;
        modalContainer.appendChild(modalDiv);
    }

    // --- 模态框控制 ---
    // [修复 3] 新增模态框打开和关闭函数
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            window.location.hash = modalId; // 可选：仍然更新哈希以便分享
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
            // 清除哈希，避免用户刷新页面时模态框仍然打开
            if (window.location.hash === `#${modalId}`) {
                history.pushState("", document.title, window.location.pathname + window.location.search);
            }
        }
    }

    // --- 通用函数与事件监听 ---
    function showLoading() {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) loadingOverlay.classList.add('hidden');
    }

    function resetAndLoad() {
        activeFilters = { style: new Set(), tag: new Set(), season: new Set(), scene: new Set() };
        fetchAllProducts();
        closeAllModalsAndClearHash();
    }
    
    function closeAllModalsAndClearHash() {
        document.querySelectorAll('.modal.active').forEach(modal => modal.classList.remove('active'));
        document.body.style.overflow = '';
        if (window.location.hash) {
            history.pushState("", document.title, window.location.pathname + window.location.search);
        }
    }
    
    // 按下 Esc 键关闭模态框
    window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeAllModalsAndClearHash();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        resetAndLoad();
        document.querySelector('.logo a').addEventListener('click', (event) => {
            event.preventDefault();
            resetAndLoad();
        });
    });
  </script>
</body>
</html>
